{% extends 'base.html' %}
{% load static %}

{% block title %}Edit City - {{ city.name }} - Ritham Tours & Travels{% endblock %}

{% block extra_css %}
<style>
    .dashboard-section {
        background: white;
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 30px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .form-label {
        font-weight: 500;
        color: var(--dark-color);
    }
    
    .form-control, .form-select {
        border-radius: 8px;
        border: 2px solid #e5e7eb;
        padding: 12px 15px;
    }
    
    .form-control:focus, .form-select:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 0.2rem rgba(37, 99, 235, 0.25);
    }
    
    .image-preview {
        max-width: 200px;
        max-height: 200px;
        border-radius: 8px;
        margin-top: 10px;
    }
    
    .current-image {
        max-width: 200px;
        max-height: 200px;
        border-radius: 8px;
        border: 2px solid #e5e7eb;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="bi bi-pencil me-2"></i>Edit City - {{ city.name }}</h2>
        <div>
            <a href="{% url 'travels_local_areas_list' city.id %}" class="btn btn-info me-2">
                <i class="bi bi-list me-2"></i>Manage Local Areas
            </a>
            <a href="{% url 'travels_cities_list' %}" class="btn btn-secondary">
                <i class="bi bi-arrow-left me-2"></i>Back to Cities
            </a>
        </div>
    </div>
    
    <div class="dashboard-section">
        <form method="POST" enctype="multipart/form-data" id="cityForm">
            {% csrf_token %}
            <div class="row">
                <div class="col-md-8">
                    <div class="mb-3">
                        <label for="name" class="form-label">City Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="name" name="name" value="{{ city.name }}" required placeholder="Enter city name">
                    </div>
                    
                    <div class="mb-3">
                        <label for="description" class="form-label">Description</label>
                        <textarea class="form-control" id="description" name="description" rows="4" placeholder="Enter city description (optional)">{{ city.description }}</textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="tourist_places" class="form-label">Tourist Places</label>
                        <textarea class="form-control" id="tourist_places" name="tourist_places" rows="4" placeholder="Enter tourist places separated by commas, e.g.:&#10;Alleppey Beach, Ambalapuzha Sree Krishna Temple, Chavaran Bhawan">{{ city.tourist_places }}</textarea>
                        <small class="text-muted">Enter tourist places separated by commas for local sightseeing</small>
                    </div>
                    
                    <div class="mb-3">
                        <label for="sightseeing_kilometers" class="form-label">Sightseeing Distance (KM)</label>
                        <input type="number" step="0.01" class="form-control" id="sightseeing_kilometers" name="sightseeing_kilometers" value="{{ city.sightseeing_kilometers|default:'' }}" placeholder="e.g., 25" min="0">
                        <small class="text-muted">Total distance covered for local sightseeing in kilometers</small>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="is_hill_station" name="is_hill_station" {% if city.is_hill_station %}checked{% endif %} onchange="toggleHillStationCharge()">
                                <label class="form-check-label" for="is_hill_station">
                                    <i class="bi bi-mountain me-1"></i>Hill Station
                                </label>
                            </div>
                            <small class="text-muted">Mark if this city is a hill station</small>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="hill_station_charge" class="form-label">Hill Station Charge (â‚¹)</label>
                            <input type="number" step="0.01" class="form-control" id="hill_station_charge" name="hill_station_charge" value="{{ city.hill_station_charge|default:'750.00' }}" placeholder="750.00" min="0" {% if not city.is_hill_station %}disabled{% endif %}>
                            <small class="text-muted">Charge per visit for hill station</small>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="latitude" class="form-label">Latitude (Optional)</label>
                            <input type="number" step="any" class="form-control" id="latitude" name="latitude" value="{{ city.latitude|default:'' }}" placeholder="e.g., 11.0168">
                            <small class="text-muted">For automatic distance calculation</small>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="longitude" class="form-label">Longitude (Optional)</label>
                            <input type="number" step="any" class="form-control" id="longitude" name="longitude" value="{{ city.longitude|default:'' }}" placeholder="e.g., 76.9558">
                            <small class="text-muted">For automatic distance calculation</small>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="is_active" name="is_active" {% if city.is_active %}checked{% endif %}>
                            <label class="form-check-label" for="is_active">
                                Active (City will be available for booking)
                            </label>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <div class="mb-3">
                        <label for="image" class="form-label">City Image</label>
                        
                        {% if city.image %}
                        <div class="mb-2">
                            <label class="form-label small">Current Image:</label>
                            <div>
                                <img src="{{ city.image.url }}" alt="{{ city.name }}" class="current-image">
                            </div>
                        </div>
                        {% endif %}
                        
                        <input type="file" class="form-control" id="image" name="image" accept="image/*" onchange="previewImage(this)">
                        <small class="text-muted">Upload a new image to replace the current one (optional)</small>
                        <img id="imagePreview" class="image-preview" alt="New Image Preview" style="display: none;">
                    </div>
                </div>
            </div>
            
            <div class="d-flex gap-2 mt-4">
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-check-circle me-2"></i>Update City
                </button>
                <a href="{% url 'travels_cities_list' %}" class="btn btn-outline-secondary">
                    <i class="bi bi-x-circle me-2"></i>Cancel
                </a>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Image preview function
    function previewImage(input) {
        const preview = document.getElementById('imagePreview');
        
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                preview.src = e.target.result;
                preview.style.display = 'block';
            };
            
            reader.readAsDataURL(input.files[0]);
        } else {
            preview.style.display = 'none';
        }
    }
    
    // Toggle hill station charge field
    function toggleHillStationCharge() {
        const isHillStation = document.getElementById('is_hill_station').checked;
        const chargeField = document.getElementById('hill_station_charge');
        
        if (isHillStation) {
            chargeField.disabled = false;
            chargeField.required = true;
            if (!chargeField.value) {
                chargeField.value = '750.00';
            }
        } else {
            chargeField.disabled = true;
            chargeField.required = false;
            chargeField.value = '750.00';
        }
    }
    
    // Form validation
    document.getElementById('cityForm').addEventListener('submit', function(e) {
        const name = document.getElementById('name').value.trim();
        
        if (!name) {
            e.preventDefault();
            showPopup('Please enter a city name.', 'error');
            document.getElementById('name').focus();
            return false;
        }
        
        if (name.length < 2) {
            e.preventDefault();
            showPopup('City name must be at least 2 characters long.', 'error');
            document.getElementById('name').focus();
            return false;
        }
    });
</script>
{% endblock %}